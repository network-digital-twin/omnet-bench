# omnet-bench
Implements a benchmark environment using OMNeT++.

## Introduction
Essentially, the implementation lies within the [`src/zte_qos/`](src/zte_qos/) folder, which is an OMNeT++ project taking [INET](https://inet.omnetpp.org/) from [`src/inet/`](src/inet/) as a reference project. The INET project is a git submodule in this repository.

Inside the main `zte_qos` project, there are three important folders:
1. [`src/`](src/zte_qos/src/): place to hold the source code of:
    1. networks (e.g., [TestNet](src/zte_qos/src/networks/TestNet.ned));
    2. network components like the [terminal](src/zte_qos/src/terminal/), [switch](src/zte_qos/src/switch/), [link](src/zte_qos/src/link/) and [packet](src/zte_qos/src/packet/);
    3. [QoS modules](src/zte_qos/src/pipeline/);
    4. other utilities (e.g., [sink](src/zte_qos/src/sink/), [JSON handler](src/zte_qos/src/util/json.h) by [nlohmann/json](https://github.com/nlohmann/json)).
    
    This folder also contains two executables pre-built by running the `Makefile` inside.
2. [`simulations/`](src/zte_qos/simulations/): place to hold the `.ini` files containing the configurations of:
    1. execution dependencies;
    2. network-specific Config profiles;
    3. parameter values of the QoS modules.

    The benchmark will be executed from this folder, using the executable in `src/` as well as the `omnetpp.ini` configuration file.
3. [`tools/`](src/zte_qos/tools/): place to hold two important Python scripts:
    1. [topology generator](src/zte_qos/tools/topo_gen/): generates the `xxNet.ned` file, which represents the network topology as well as the locations of the switch info data and the trace data. For networks with customized names, extra Config blocks will be provided by the script for the users to add to the corresponding `.ini` configuration file. When utilizing JSON info files, these JSON files will be transformed from the original YAML info files.
    2. [result analyzer](src/zte_qos/tools/analysis/): extracts result logs from a `.log` file generated by the simulation, dumps packet results to a `*-res-packets.csv` file, and processes the simulation/per-packet-flow metrics into a `*-res-simulation.json` file.

## Getting Started
This section clarifies the steps needed to run the benchmark without building the OMNeT++ project.

### Requirements
To run the benchmark, the OMNeT++ environment is not mandatory. However, a Python environment is needed to execute the topology generation script and the result analysis script.

The Python dependencies are listed as follows:
1. `PyYAML==6.0.1`: loading/dumping of YAML files, required by the [topology generator](src/zte_qos/tools/topo_gen/requirements.txt);
2. `pandas==2.2.0`: loading/dumping of CSV files, required by the [result analyzer](src/zte_qos/tools/analysis/requirements.txt);
3. `pyarrow==15.0.0`: future dependency of `pandas`.

### Clarifications
Below specifies the minimum operations required to perform a benchmark on a specified network with a specified packet trace.

**NOTE**: to reduce the number of required operations, many settings are kept as default values. Specifically:
1. all switch info YAML files should be placed in one single folder;
2. the network will be named as "ZteNet", and generated in `src/zte_qos/src/networks/gen/`;
3. results will be recorded to `src/zte_qos/simulations/results/`.
4. JSON parsing instead of YAML parsing will be enabled.

### 1. Prepare network & trace data
Two categories of data are required:
1. `info/<SWITCH_ID>.yaml`: a directory, not necessarily named `info/`, should contain all the switch info YAML files. These files include the routing information of the switches, which is required by the [RouteSelectors](src/zte_qos/src/switch/routing/RouteSelector.ned).
2. `trace.txt`: a text file specifying a trace of packets to be simulated on the network, which is required by the [Terminal](src/zte_qos/src/terminal/Terminal.ned). Each line in the file represents a packet, whose attributes are separated by one single space. Lines starting with a "#" are ignored.

### 2. Generate network topology
Go to folder where the network topology generator resides:
```bash
cd src/zte_qos/tools/topo_gen/
```

Install the Python dependencies (remember to switch to a `conda` environment if `conda` is utilized):
```bash
python -m pip install -r requirements.txt
```

Then, run `main.py` as follow:
```bash
python main.py -i <INFO_DIR> -t <TRACE_FN> -j 1
```
where `<INFO_DIR>` is the folder path holding the switch info files, and `<TRACE_FN>` is the file path of the packet trace. `-j` enables JSON parsing of the info files. As an example, one can run:
```bash
python main.py -i ../../simulations/dataset/test/info/ -t ../../simulations/dataset/test/trace.txt -j 1
```
The output will be:
```bash
"../../src/networks/gen/ZteNet.ned" successfully generated.
```
According to the output, the corresponding `ZteNet.ned` file has been successfully generated.

### 3. Run the simulation
After successful generation, go to the first [`src/`](src/) directory of the repository:
```bash
# should be at src/
cd ../../../
```

Then, run the simulation using the `Makefile`:
```bash
NET=ZteNet SIM_TIME=<SIM_TIME>s make run
```
where `<SIM_TIME>` specifies the simulation time duration in seconds. Note that this is the virtual simulation time, but not the real-world wall clock time. As an example, to simulate 60 seconds (the simulation stops when virtual time reaches 60s), one can run:
```bash
NET=ZteNet SIM_TIME=60s make run
```
The output will be:
```bash
git submodule update --init --recursive
cd zte_qos/simulations; ../src/zte_qos -m -u Cmdenv -c ZteNet omnetpp.ini --sim-time-limit=60s
OMNeT++ Discrete Event Simulation  (C) 1992-2022 Andras Varga, OpenSim Ltd.
Version: 6.0.2, build: 231006-7d5ca33dba, edition: Academic Public License -- NOT FOR COMMERCIAL USE
See the license for distribution terms and warranty disclaimer

Setting up Cmdenv...

Loading NED files from **/omnet-bench/src/zte_qos/src:  10
Loading NED files from **/omnet-bench/src/zte_qos/simulations:  1
Loading NED files from **/omnet-bench/src/inet/examples:  179
Loading NED files from **/omnet-bench/src/inet/showcases:  70
Loading NED files from **/omnet-bench/src/inet/src:  1142
Loading NED files from **/omnet-bench/src/inet/tests/validation:  5
Loading NED files from **/omnet-bench/src/inet/tests/networks:  6
Loading NED files from **/omnet-bench/src/inet/tutorials:  20

Preparing for running configuration ZteNet, run #0...
Redirecting output to file "**/omnet-bench/src/zte_qos/simulations/results/ZteNet-#0.log"...

End.
```

After the simulation, a `.log` file will be generated in the `zte_qos/simulations/results/` folder. For this section, the name will always be `ZteNet-#0.log`, where `#0` represents Run Number 0.

### 4. Analyze the simulation result
Go to the folder where the result analyzer resides:
```bash
cd zte_qos/tools/analysis/
```

Install the Python dependencies:
```bash
python -m pip install -r requirements.txt
```

Then, run `main.py` as follow:
```bash
python main.py -l <LOG_FN>
```
where `<LOG_FN>` is the file path of the result `.log` file. Again, as an example, one can run:
```bash
python main.py -l ../../simulations/results/ZteNet-#0.log
```
The output will be:
```bash
{
  "start": "2024-02-23 08:05:39.015123",
  "end": "2024-02-23 08:05:39.015898",
  "elapsed": 0.000774416,
  "delay": {
    "min": 0.0,
    "max": 48000009999.99999,
    "avg": 21750008000.0
  },
  "jitter": 17290896072.78975,
  "drop": 0
}
Successfully generated "../../simulations/results/ZteNet-#0-res-simulation.json"
Successfully generated "../../simulations/results/ZteNet-#0-res-packets.csv"
```
According to the output, the corresponding `ZteNet-#0-res-simulation.json` and `ZteNet-#0-res-packets.csv` files have been successfully generated. The output JSON is identical to the `*-res-simulation.json` file.

Below shows the resulted `ZteNet-#0-res-packets.csv` file for reference:
```csv
pid,start_ts,end_ts,drop,module
150,2500000000.0,2500000000.0,0,ZteNet.s_0.dstSink
135,2000000000.0,8250010000.0,0,ZteNet.s_2.dstSink
123,1500000000.0,24750010000.0,0,ZteNet.s_1.dstSink
33,1000000000.0,32250009999.999996,0,ZteNet.s_1.dstSink
6,500000000.0,48500009999.99999,0,ZteNet.s_1.dstSink
```

## For Developers

TODO.
