import os
import json
import itertools
from pathlib import Path

import yaml


class Switch:
    """ Switch model. """
    def __init__(self, info_fn: str):
        self.info_fn = info_fn
        if not self.info_fn.endswith('.yaml'):
            raise ValueError(f'Not a yaml file: {self.info_fn}')
        self.yaml_dict: dict = yaml.load(open(self.info_fn), Loader=yaml.FullLoader)
        # fields
        self.id: int = int(Path(self.info_fn).stem)
        self.port_bw: dict[str, float] = self.yaml_dict['ports']    # ID => bandwidth-bps
        self.qos: str = self.yaml_dict['qos']
        self.routing: dict[int, dict] = self.yaml_dict['routing']
        self.switch_type: str = self.yaml_dict['type']

    def to_ned(self, indent: int = 4) -> list[str]:
        """
        Return a list formatted string lines of the switch NED block.
        :param indent: indent level
        """
        indent_str = ' ' * indent
        return [
            f's_{self.id}: Switch {{',
            indent_str + f'sid = {self.id};',
            f'}}'
        ]

    def to_local_json(self, path: str) -> None:
        """
        Save yaml_dict to local json file.
        :param path: path of the resulting json file
        """
        with open(path, 'w') as f:
            json.dump(self.yaml_dict, f, indent=2)

    def __str__(self):
        return f'Switch[{self.id}]'

    def __repr__(self):
        return self.__str__()


class Network:
    NAME_DEFAULT = 'ZteNet'
    NED_DIR_DEFAULT = '../../src/networks/gen/'
    INI_DIR_DEFAULT = '../../simulations/'

    def __init__(self, info_dir: str, trace_fn: str,
                 name: str = NAME_DEFAULT, description: str = None,
                 ini_dir: str = INI_DIR_DEFAULT, out_dir: str = NED_DIR_DEFAULT):
        self.info_dir = info_dir
        if not os.path.isdir(self.info_dir):
            raise NotADirectoryError(f'{self.info_dir} is not a directory')
        self.trace_fn = trace_fn
        if not os.path.isfile(self.trace_fn):
            raise FileNotFoundError(f'{self.trace_fn} is not a valid file')
        self.name = name
        self.description = f'{self.name}.' if description is None else description
        self.ini_dir = ini_dir
        if not os.path.isdir(self.ini_dir):
            raise NotADirectoryError(f'{self.ini_dir} is not a directory')
        self.out_dir = out_dir
        if not os.path.isdir(self.out_dir):
            os.makedirs(out_dir)
        self.switches = self.load_topology()

    def load_topology(self) -> dict[int, Switch]:
        """ Load topology as a dict of switch_id => switch from the info directory. """
        res: dict[int, Switch] = {}
        for info_fn in os.listdir(self.info_dir):
            if not info_fn.endswith('.yaml'):
                continue
            cur_switch = Switch(os.path.join(self.info_dir, info_fn))
            res[cur_switch.id] = cur_switch
        return res

    def generate_ned(self, indent: int = 4) -> None:
        """
        Generate NED file representing the network.
        :param indent: indent level
        """
        out_fn = os.path.join(self.out_dir, f'{self.name}.ned')
        with open(out_fn, 'w') as f:
            f.write('//\n'
                    '// Auto-generated by "tools/topo_gen/main.py". DO NOT EDIT.\n'
                    '//\n')
            f.write('\n')
            # package
            f.write('package zte_qos.networks.gen;\n')
            f.write('\n')
            # import
            f.write('import zte_qos.terminal.Terminal;\n'
                    'import zte_qos.switch.Switch;\n'
                    'import zte_qos.link.Link;\n')
            f.write('\n')
            # network
            f.write('\n'.join(self.to_network_ned(indent)))
            f.write('\n')
        # TODO: logging and suggest in stdout to put Config into GenNets.ini

    def to_network_ned(self, indent: int = 4) -> list[str]:
        """
        Return a list formatted string lines of the network NED block.
        :param indent: indent level
        """
        indent_str = ' ' * indent
        return [
            f'// {self.description}',
            f'network {self.name}',
            f'{{',
            # parameters
            *[(indent_str + line) for line in self.to_parameters_ned(indent)],
            # submodules
            *[(indent_str + line) for line in self.to_submodules_ned(indent)],
            f'}}'
        ]

    def to_parameters_ned(self, indent: int = 4) -> list[str]:
        """
        Return a list formatted string lines of the network parameters NED block.
        :param indent: indent level
        """
        indent_str = ' ' * indent
        # TODO: is there a cleaner way?
        traceFileRel = os.path.relpath(self.trace_fn, self.ini_dir).replace('\\', '/')
        infoDirRel = os.path.relpath(self.info_dir, self.ini_dir).replace('\\', '/')
        if not infoDirRel.endswith('/'):
            infoDirRel += '/'
        return [
            f'parameters:',
            indent_str + f't.traceFile = "{traceFileRel}";',
            indent_str + f's_*.infoDir = "{infoDirRel}";'
        ]

    def to_submodules_ned(self, indent: int = 4) -> list[str]:
        """
        Return a list formatted string lines of the network submodules NED block.
        :param indent: indent level
        """
        indent_str = ' ' * indent
        return [
            f'submodules:',
            # terminal
            indent_str + f'// terminal',
            indent_str + f't: Terminal;',
            # switches
            indent_str + f'// switches',
            *[(indent_str + line) for line in itertools.chain(*[*[s.to_ned(indent) for s in self.switches.values()]])]
        ]

    def __str__(self):
        return f'Network-{self.name}'

    def __repr__(self):
        return self.__str__()
